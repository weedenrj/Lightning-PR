# https://docs.anthropic.com/en/docs/claude-code/github-actions
name: Claude Code Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened]
    # types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude review')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude review')) ||
      (github.event_name == 'pull_request' && github.event.action == 'opened')
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      checks: write
    
    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ steps.pr.outputs.number }}/merge
          fetch-depth: 0

      - name: Run Standard Claude Code Review
        id: claude-review-standard
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are reviewing PR #${{ steps.pr.outputs.number }}.
            
            GOAL: Find "fix before ship" issues - real bugs that will break existing features.
            IGNORE: Style, imports, "why are these files changed together" (drive-by fixes are normal).
            
            CRITICAL COMMANDS - Use these exact commands with the PR number ${{ steps.pr.outputs.number }}:
            - gh pr view ${{ steps.pr.outputs.number }} --json title,body,number
            - gh pr diff ${{ steps.pr.outputs.number }}
            - gh pr comment ${{ steps.pr.outputs.number }} --body "your review text"
            
            DO NOT discover the PR number yourself. Use ${{ steps.pr.outputs.number }} in all commands.
            
            ---
            
            STEP 1: UNDERSTAND INTENT
            
            Read PR context BEFORE looking at code:
            - gh pr view ${{ steps.pr.outputs.number }} --json title,body,number
            - What problem is this PR solving?
            
            This context guides your entire review.
            
            ---
            
            STEP 2: ASSESS PR CRITICALITY
            
            Look at ALL changed files collectively and determine:
            
            Is this PR touching existing critical systems?
            - Changes to core services (*Service.ts, *Domain.ts files)
            - Changes to entity models or business logic
            - Changes to money/booking/scheduling systems
            â†’ HIGH RISK: Allocate deep investigation time
            
            OR is this PR mostly new code?
            - All new untracked files that can't break existing systems
            - Pure UI additions with no integration
            â†’ LOW RISK: Lighter review is appropriate
            
            File names and paths are self-documenting - use them to assess risk.
            
            ---
            
            STEP 3: INVESTIGATE IMPACT
            
            For each changed function, class, component, or type:
            
            1. GREP FOR USAGES:
               Use Grep tool to search the codebase for "functionName"
               
               Don't review import statements - search for actual usage sites.
            
            2. REASON ABOUT EACH USAGE:
               - Does this usage still work with the change?
               - Does it need updating? Has it already been updated?
               - What edge cases might this usage expose?
            
            3. EXPLORE CONTEXT:
               - Read related entity models (packages/core/model/ or apps/api/src/features/v1/[feature]/)
               - Models contain business rule comments
               - Trace data flows: calculation â†’ storage â†’ display
               - Find similar code that might have the same issue
            
            4. VERIFY CORRECTNESS:
               - Edge cases handled? (default data, undefined/null/empty, missing optionals)
               - Business rules preserved? (check model comments)
               - Data handled correctly? (money, dates, timezones)
               - All usages addressed?
            
            This is exploratory - follow threads wherever they lead.
            
            ---
            
            STEP 4: REPORT FINDINGS
            
            Format your review with headers and a few emojis:
            
            ## ðŸ“‹ Context
            What this PR accomplishes (1-2 sentences)
            
            ## âš¡ Risk Level
            High/Medium/Low based on what systems are touched
            
            ## ðŸ” Investigation
            What you explored:
            - Functions grepped and usages examined
            - Models and business logic checked
            - Integration points verified
            
            ## Findings
            
            ### ðŸ”´ Fix Before Ship
            - **[file:line]** - Issue description and impact
            
            ### ðŸŸ¡ Needs Verification
            - **[file:line]** - Uncertain issue requiring validation
            
            ### âœ… Looking Good
            - Brief positive observations if applicable
            
            If you find nothing wrong, say so clearly with âœ…
            
            ---
            
            TOOLS: 
            - gh pr view ${{ steps.pr.outputs.number }}
            - gh pr diff ${{ steps.pr.outputs.number }}
            - Grep "term" (to search the codebase for usages)
            - gh pr comment ${{ steps.pr.outputs.number }} --body "your review"

            CRITICAL: Post your review exactly ONCE at the end. Do not post multiple comments. Combine all findings into a single comprehensive review comment.

            Core principle: Grep changed functions, reason about every usage, follow the threads.
          claude_args: '--model claude-sonnet-4-5-20250929 --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: Handle review errors
        if: steps.claude-review-standard.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          
          if [ -z "$PR_NUMBER" ]; then
            echo "Error: Could not determine PR number"
            exit 1
          fi
          
          PR_STATE=$(gh pr view "$PR_NUMBER" --json state -q .state 2>/dev/null || echo "UNKNOWN")
          HEAD_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid -q .headRefOid 2>/dev/null || echo "${{ github.sha }}")
          
          if [ "$PR_STATE" = "CLOSED" ]; then
            CONCLUSION="neutral"
            TITLE="Review cancelled - PR was closed"
            SUMMARY="The PR was closed before the review could complete."
          else
            CONCLUSION="failure"
            TITLE="Review failed"
            SUMMARY="The Claude code review failed. This could be due to rate limits, token exhaustion, or API errors. Check the workflow logs for details."
          fi
          
          OUTPUT_JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg summary "$SUMMARY" \
            '{title: $title, summary: $summary}')
          
          gh api repos/${{ github.repository }}/check-runs \
            --method POST \
            -f name="Claude Code Review" \
            -f head_sha="$HEAD_SHA" \
            -f status="completed" \
            -f conclusion="$CONCLUSION" \
            --raw-field "output=$OUTPUT_JSON"
          
          if [ "$CONCLUSION" = "neutral" ]; then
            exit 0
          else
            exit 1
          fi

      # Example: User-specific custom review prompt
      # Uncomment and modify to create custom review behavior for specific users
      # - name: Run Custom Claude Code Review
      #   if: |
      #     (github.event.comment && github.event.comment.user.login == 'your-username') ||
      #     (github.event_name == 'pull_request' && github.event.pull_request.user.login == 'your-username') ||
      #     (github.event.review && github.event.review.user.login == 'your-username')
      #   id: claude-review-custom
      #   uses: anthropics/claude-code-action@v1
      #   with:
      #     claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      #     prompt: |
      #       Your custom review instructions here.
      #       You are reviewing PR #${{ steps.pr.outputs.number }}.
      #       
      #       Use these commands:
      #       - gh pr view ${{ steps.pr.outputs.number }}
      #       - gh pr diff ${{ steps.pr.outputs.number }}
      #       - gh pr comment ${{ steps.pr.outputs.number }} --body "your review"
      #     claude_args: '--model claude-sonnet-4-5-20250929 --allowed-tools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*)"'

