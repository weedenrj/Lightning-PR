---
description: Review code changes for bugs and side effects
argument-hint: [linear-id|scope] [scope]
allowed-tools: Read, Glob, Grep, Task, Bash
---

Perform a thorough code review to catch unexpected side effects and bugs. Focus on finding "fix before ship" issues - real bugs that will break existing features.

**IGNORE:** Style, imports, "why are these files changed together" (drive-by fixes are normal).

**Scope handling:**
- Parse $ARGUMENTS to determine review scope
- If first argument matches Linear ID pattern (VAL-123, 123, val-123), extract and normalize to VAL-### format
- Supported scopes: `unstaged`, `staged`, `HEAD~N`, `main..HEAD`, `branch-name`, file paths, or directory paths
- For remote branch reviews, use git commands to fetch and review remote branches

## STEP 0: FETCH LINEAR CONTEXT (if provided)

If $ARGUMENTS contains a Linear issue ID:
- Parse the ID (VAL-123, 123, val-123 all become VAL-123)
- Use the Linear CLI: `npx tsx apps/scripts/src/scripts/linear/Linear.ts getIssue <issue-id>`
- Parse JSON output to read issue title, description, and acceptance criteria
- Include this business context in your review

## STEP 1: UNDERSTAND INTENT

Determine what code changed and why:

**For remote branch reviews (branch-name argument):**
- Fetch the branch: `git fetch origin <branch-name>`
- List commits: `git log origin/<branch-name> --oneline`
- Get commit diffs: `git diff origin/main...origin/<branch-name>`
- Read commit messages and aggregate all changes across commits

**For local reviews (unstaged, staged, HEAD~N, main..HEAD):**
- Changed files: !`git status --porcelain | cut -c4-`
- Staged changes: !`git diff --cached --name-only`
- Commit history: !`git log --oneline -10`
- Read commit messages to understand intent

**For file/directory reviews:**
- Read the specified files or all files in the directory
- Understand the purpose of each file

This context guides your entire review.

## STEP 2: ASSESS CRITICALITY

Look at ALL changed files collectively and determine risk level:

**HIGH RISK** - Touching existing critical systems:
- Core services (`*Service.ts`, `*Domain.ts` files)
- Entity models or business logic
- Money/booking/scheduling systems
‚Üí Allocate deep investigation time

**LOW RISK** - Mostly new code:
- All new untracked files that can't break existing systems
- Pure UI additions with no integration
‚Üí Lighter review is appropriate

File names and paths are self-documenting - use them to assess risk.

## STEP 3: INVESTIGATE IMPACT

For each changed function, class, component, or type:

1. **GREP FOR USAGES:**
   - Use `grep` tool to search codebase for the function/type/component name
   - Search beyond import statements to find actual call sites and usages

2. **REASON ABOUT EACH USAGE:**
   - Does this usage still work with the change?
   - Does it need updating? Has it already been updated?
   - What edge cases might this usage expose?

3. **EXPLORE CONTEXT:**
   - Read related entity models (`packages/core/model/` or `apps/api/src/features/v1/[feature]/`)
   - Models contain business rule comments
   - Trace data flows: calculation ‚Üí storage ‚Üí display
   - Use `codebase_search` to find similar code that might have the same issue

4. **VERIFY CORRECTNESS:**
   - Edge cases: default data, undefined/null/empty, missing optionals
   - Business rules: preserved? (check model comments)
   - Data handling: money, dates, timezones correct?
   - Breaking changes: function signatures, type changes affecting consumers
   - All usages addressed?

Follow threads wherever they lead. **Core principle:** Grep changed functions, reason about every usage.

## STEP 4: REPORT FINDINGS

Format your review with this structure:

```
## üìã Context
What this code accomplishes (1-2 sentences)

## ‚ö° Risk Level
High/Medium/Low

## üîç Investigation
- Functions grepped and usages examined
- Models and business logic checked
- Integration points verified

## Findings

### üî¥ Fix Before Ship
- **[file:line]** - Issue and impact

### üü° Needs Verification
- **[file:line]** - Uncertain issue

### ‚úÖ Looking Good
- Positive observations

## Side Effects Summary

| Issue | Severity | Status | Blocking? |
|-------|----------|--------|-----------|
| Brief description | Low/Medium/High | Acceptable trade-off / Needs fix / Minor quirk / etc | Yes/No - explanation |
```

If you find nothing wrong, say so clearly with ‚úÖ and empty Side Effects Summary table.
